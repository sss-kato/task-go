name: Task-Go
on: push

env:
  DB_USER: ${{secrets.DB_USER}}
  DB_PW: ${{secrets.DB_PW}}
  DB_HOST: ${{secrets.DB_HOST}}
  DB_PORT: ${{secrets.DB_POST}}
  DB_NAME: ${{secrets.DB_NAME}}

jobs: 
  build: 
    name: Go Test
    runs-on: ubuntu-latest
    steps:
      # - name: Test
      #   run: sudo add-apt-repository ppa:longsleep/golang-backports
      # - name: Test2
      #   run: sudo apt update
      # - name: Go Download
      #   run: sudo apt install golang-1.18
      # - name: Go Version
      #   run: go version
      - name: Setup Go
        uses: actions/setup-go@v3
        with:
          go-version: '1.18.0'
          # cache: true
          # cache-dependency-path: go.sum
      - name: Go Version
        run: go version
      
      - name: Bracnk Checkout
        uses: actions/checkout@v2
        with: 
          ref: ${{ github.ref }}
      
      - name: Go Build
        run: go build

      - name: Docker Compose Up
        run: docker-compose up -d
      - name: Install golang-migrate CLI
        run: |
          curl -L https://packagecloud.io/golang-migrate/migrate/gpgkey | sudo apt-key add -
          echo "deb https://packagecloud.io/golang-migrate/migrate/ubuntu/ $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/migrate.list
          sudo apt-get update
          sudo apt-get install -y migrate
      # - name: Set Env
      #   run : export CURRENT_DB_USER=user CURRENT_DB_PW=passwd CURRENT_DB_HOST=localhost CURRENT_DB_PORT=5434 CURRENT_DB_NAME=user
      # - name: Go Run TestCode
        # run: go test -v ./...
        # run: go run ./migrate/migrate.go
        # run: cd ./repository;go test -run Test_userRepository_RegistUser
        # env:
        #   CURRENT_DB_USER: user
        #   CURRENT_DB_PW: passwd
        #   CURRENT_DB_HOST: localhost
        #   # CURRENT_DB_HOST: "127.0.0.1"
        #   CURRENT_DB_PORT: "5432"
        #   CURRENT_DB_NAME: user